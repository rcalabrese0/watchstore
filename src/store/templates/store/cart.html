{% extends 'store/base.html' %}
{% load static %}

{% block title %}Carrito{% endblock %}

{% block content %}
<div class="container">
    <!-- Toast para notificaciones -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Carrito</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirmar acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    ¿Estás seguro de que deseas eliminar este producto del carrito?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmModalAction">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Tu Carrito</h2>
    {% if cart_items %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>{{ item.product.name }}</td>
                    <td>${{ item.product.price }}</td>
                    <td>
                        <div class="input-group" style="max-width: 150px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQuantity({{ item.product.id }}, -1)">-</button>
                            <input type="number" class="form-control text-center" 
                                   value="{{ item.quantity }}" 
                                   min="1" 
                                   max="{{ item.product.stock }}"
                                   onchange="updateQuantity({{ item.product.id }}, this.value, true)"
                                   data-stock="{{ item.product.stock }}"
                                   style="width: 60px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQuantity({{ item.product.id }}, 1)">+</button>
                        </div>
                        <small class="text-muted">Stock disponible: {{ item.product.stock }}</small>
                    </td>
                    <td>${{ item.subtotal }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="showRemoveConfirmation({{ item.product.id }}, '{{ item.product.name }}')">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                    <td><strong>${{ total }}</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="text-end mt-3">
        <a href="{% url 'product_list' %}" class="btn btn-secondary me-2">Seguir Comprando</a>
        <button class="btn btn-success" onclick="createOrder()">Realizar Pedido</button>
    </div>
    {% else %}
    <div class="alert alert-info">
        Tu carrito está vacío. <a href="{% url 'product_list' %}">Ver productos</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let toast;
let confirmModal;
let productToRemove = null;

document.addEventListener('DOMContentLoaded', function() {
    toast = new bootstrap.Toast(document.getElementById('cartToast'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    
    // Configurar el botón de confirmación del modal
    document.getElementById('confirmModalAction').addEventListener('click', function() {
        if (productToRemove !== null) {
            removeFromCart(productToRemove);
            confirmModal.hide();
        }
    });
});

function showToast(title, message, type = 'success') {
    const toastEl = document.getElementById('cartToast');
    const titleEl = document.getElementById('toastTitle');
    const messageEl = document.getElementById('toastMessage');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // Remover clases anteriores
    toastEl.querySelector('.toast-header').className = 'toast-header';
    
    // Agregar clase según el tipo
    if (type === 'success') {
        toastEl.querySelector('.toast-header').classList.add('bg-success', 'text-white');
    } else if (type === 'error') {
        toastEl.querySelector('.toast-header').classList.add('bg-danger', 'text-white');
    }
    
    toast.show();
}

function showRemoveConfirmation(productId, productName) {
    productToRemove = productId;
    document.getElementById('confirmModalBody').textContent = 
        `¿Estás seguro de que deseas eliminar "${productName}" del carrito?`;
    confirmModal.show();
}

function updateQuantity(productId, amount, isDirectInput = false) {
    let input = document.querySelector(`input[onchange*="${productId}"]`);
    let currentQty = parseInt(input.value);
    let maxStock = parseInt(input.dataset.stock);
    let newQty;

    if (isDirectInput) {
        newQty = parseInt(amount);
    } else {
        newQty = currentQty + parseInt(amount);
    }

    // Validar límites
    if (newQty < 1) {
        newQty = 1;
        showToast('Cantidad mínima', 'La cantidad mínima es 1', 'error');
        input.value = newQty;
        return;
    } else if (newQty > maxStock) {
        newQty = maxStock;
        showToast('Stock insuficiente', `Solo hay ${maxStock} unidades disponibles`, 'error');
        input.value = newQty;
        return;
    }

    // Actualizar input
    input.value = newQty;

    // Enviar actualización al servidor
    fetch(`/cart/add/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            quantity: newQty,
            update: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            showToast('Error', data.error || 'Error al actualizar el carrito', 'error');
            setTimeout(() => location.reload(), 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Error al actualizar el carrito', 'error');
        setTimeout(() => location.reload(), 2000);
    });
}

function removeFromCart(productId) {
    fetch(`/cart/remove/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Éxito', 'Producto eliminado del carrito', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || 'Error al eliminar del carrito', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Error al eliminar del carrito', 'error');
    });
}

function createOrder() {
    fetch('/order/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        } else {
            showToast('Error', 'Error al crear el pedido', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Error al crear el pedido', 'error');
    });
}
</script>
{% endblock %}
